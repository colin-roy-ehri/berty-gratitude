# Berty Repository - Claude Context File

## Project Overview

**Berty** is an open, secure, offline-first, peer-to-peer and zero trust messaging application built on the Wesh Protocol. This repository is being forked to create **Gratitude**, a privacy-first mutual aid platform.

### Core Characteristics
- **Technology**: Go backend + React Native frontend
- **Architecture**: P2P messaging using IPFS, OrbitDB, and BLE
- **License**: Apache 2.0 / MIT dual license
- **Status**: Active development, not yet production-ready

## Development Plan Context

This repository is being prepared for a fork called **Gratitude** - a mutual aid community network. The development plan is documented in `docs/BERTY_DEVELOPMENT_PLAN.md`.

### Project Vision (Gratitude)
Build a privacy-first, peer-to-peer mutual aid platform that enables community members to broadcast needs and offers without central servers, surveillance, or hierarchical gatekeeping.

**Core Principles**:
- No servers, no surveillance, no central authority
- Horizontal relationships (no reputation/trust scoring)
- Dignity-preserving (categorical offers/needs, not hierarchical)
- Accessible to vulnerable populations
- Extensible for community-specific AI/matching

### Development Phases
1. **Phase 1 (Weeks 1-4)**: Foundation & Setup - Fork, setup environment, understand Berty architecture
2. **Phase 2 (Weeks 5-8)**: Custom Codec Integration - Binary message format (64-75 bytes)
3. **Phase 3 (Weeks 9-12)**: UI for Offers/Needs - React Native screens
4. **Phase 4 (Weeks 13-16)**: Local Semantic Matching - Algorithm for matching offers/needs
5. **Phase 5 (Weeks 17-20)**: Community Testing & Iteration
6. **Phase 6 (Week 21+)**: Future Expansion - Hardware mesh, advanced matching

## Repository Structure

```
berty/
├── go/                          # Go backend code
│   ├── cmd/                     # Command-line tools
│   │   ├── berty/              # Main Berty CLI (daemon, mini)
│   │   ├── rdvp/               # Rendez-vous point server
│   │   ├── welcomebot/         # Onboarding bot
│   │   └── testbot/            # Testing bot
│   ├── pkg/                     # Go packages
│   │   ├── bertyaccount/       # Account management
│   │   ├── bertyauth/          # Authentication
│   │   ├── bertybridge/        # gomobile bindings for React Native
│   │   ├── bertymessenger/     # Messenger service
│   │   ├── messengertypes/     # Message type definitions
│   │   └── [24 total packages]
│   ├── framework/               # Mobile framework code
│   └── internal/                # Internal packages
│
├── js/                          # React Native frontend
│   ├── packages/                # JavaScript packages
│   │   ├── api/                # API definitions
│   │   ├── components/         # React components (195 files)
│   │   ├── screens/            # Screen components (181 files)
│   │   ├── redux/              # Redux state management
│   │   ├── navigation/         # Navigation setup
│   │   ├── hooks/              # React hooks
│   │   ├── contexts/           # React contexts
│   │   ├── grpc-bridge/        # gRPC bridge to Go backend
│   │   ├── native-modules/     # Native module bindings
│   │   └── utils/              # Utility functions
│   ├── android/                 # Android-specific code
│   ├── ios/                     # iOS-specific code
│   └── web/                     # Web platform code
│
├── api/                         # Protocol Buffer definitions
│   ├── accounttypes/           # Account types (.proto)
│   ├── messengertypes/         # Messenger types (.proto)
│   ├── directorytypes/         # Directory types (.proto)
│   ├── pushtypes/              # Push notification types (.proto)
│   └── bertybridge/            # Bridge types (.proto)
│
├── docs/                        # Documentation
│   ├── BERTY_DEVELOPMENT_PLAN.md  # ⭐ Main development plan for Gratitude fork
│   ├── architecture/           # Architecture diagrams and ADRs
│   ├── apis/                   # API documentation
│   └── protocol/               # Protocol documentation
│
├── config/                      # Configuration files
├── tool/                        # Development tools
├── berty-bridge-expo/          # Expo bridge implementation
└── unspsc/                      # ⭐ UNSPSC Classification System for Mutual Aid
    ├── UNSPSC_QUICK_START.md           # Quick start guide for using UNSPSC files
    ├── unspsc-for-llms.md              # LLM-optimized context document
    ├── unspsc-mutual-aid-reference.json # Machine-readable data
    └── unspsc-types.ts                 # TypeScript types for IDE autocomplete
```

## UNSPSC Classification System

The `unspsc/` folder contains a comprehensive classification system for categorizing mutual aid offers and needs using the United Nations Standard Products and Services Code (UNSPSC).

### UNSPSC Files Overview

**Purpose**: Provide a standardized way to classify goods and services in mutual aid messages using 8-digit codes.

**Hierarchy**: `Segment (2 digits) → Family (4 digits) → Class (6 digits) → Commodity (8 digits)`

Example: `50201506`
- `50` = Food, Beverage & Tobacco Products (Segment)
- `5020` = Food Products (Family)
- `502015` = Fresh Fruits & Vegetables (Class)
- `50201506` = Fresh Vegetables (Commodity)

### File Descriptions

#### 1. `unspsc-types.ts` - TypeScript Types
**Use for**: IDE autocomplete, type-safe code validation, building UI

```typescript
import { UNSPSCCode, UNSPSC_CODES, COMMON_CODES, searchCodes } from './unspsc-types'

// Autocomplete: COMMON_CODES.FRESH_VEGETABLES → 50201506
const offerCode: UNSPSCCode = COMMON_CODES.FRESH_VEGETABLES

// Get description
const desc = UNSPSC_CODES[offerCode]  // "Fresh vegetables"

// Search for codes
const results = searchCodes('wheelchair')
```

**Features**:
- Type-safe 8-digit UNSPSC codes
- Complete mapping of codes to descriptions
- Utility functions: `getSegment()`, `getFamily()`, `getClass()`, `isRestrictedCode()`, `validateCodeForMessageType()`
- Search functionality
- Common codes for quick access

#### 2. `unspsc-mutual-aid-reference.json` - Machine-Readable Data
**Use for**: Backend data processing, API responses, message validation

**Structure**:
```json
{
  "metadata": { "version": "1.0", "last_updated": "2025-12-06" },
  "segments": {
    "50": {
      "name": "Food, Beverage & Tobacco Products",
      "families": {
        "5020": {
          "name": "Food Products",
          "classes": {
            "502015": {
              "name": "Fresh Fruits & Vegetables",
              "commodities": {
                "50201506": "Fresh vegetables"
              }
            }
          }
        }
      }
    }
  },
  "utilities": {
    "restricted_segments": ["82", "83", "84", "85", "90"]
  }
}
```

#### 3. `unspsc-for-llms.md` - LLM Context Document
**Use for**: Claude integration, AI-assisted code selection, natural language processing

**Purpose**: Provide complete UNSPSC context to LLMs for:
- Interpreting user descriptions and suggesting appropriate codes
- Validating that codes match user intent
- Flagging inappropriate professional service codes
- Teaching the LLM about mutual aid categorization

**Example prompt**:
```
User said: "I have extra tomatoes from my garden to share"

Based on the UNSPSC reference:
→ Segment 50 (Food, Beverage)
→ Family 5020 (Food Products)
→ Class 502015 (Fresh Fruits & Vegetables)
→ Commodity 50201506 (Fresh vegetables)
```

#### 4. `UNSPSC_QUICK_START.md` - Integration Guide
**Use for**: Understanding how to use all three files together

**Covers**:
- Which file to use for different scenarios
- Integration examples (full flow from user input to BLE transmission)
- Building code selector UI
- Validation in message codec
- Testing the integration

### UNSPSC Segments Included

**Material Goods**:
- **10**: Animal & Vegetable Products (pet supplies)
- **25**: Transportation & Storage (bikes, transit passes)
- **31**: Tools & Hardware
- **39**: Electrical Equipment (batteries, lights)
- **43**: Information Technology (computers, phones)
- **45**: Musical Instruments
- **46**: Environmental & Weather (fans, heaters)
- **47**: Arts, Crafts & Hobbies
- **48**: Sports, Toys & Recreation
- **49**: Baby & Infant Products
- **50**: Food, Beverage & Tobacco ⭐ *Most common*
- **55**: Books, Media & Publishing
- **60**: Education & Training (school supplies)
- **72**: Medical Supplies & Personal Care ⭐ *Critical for accessibility*

**Peer Support Services**:
- **93**: Social Services & Community Support (peer-based only)
  - Emotional & social support
  - Practical assistance (childcare, rides, moving help)
  - Skill sharing & education
  - Harm reduction & safety

### Restricted Segments (Professional Services)

These codes can **ONLY** appear in REQUEST messages (seeking help), **NEVER** in OFFER messages:
- **82**: Legal Services
- **83**: Professional Education
- **84**: Financial Services
- **85**: Healthcare Services
- **90**: Commercial Childcare

**Rationale**: Prevents commodification and maintains peer-to-peer mutual aid principles.

### Most Common Codes

```typescript
// Food (most frequent)
50201506 - Fresh vegetables
50201507 - Fresh fruits
50201710 - Prepared meals
50203506 - Non-alcoholic beverages

// Mobility & Accessibility
72101620 - Wheelchairs (powered)
72101503 - Wheelchairs (manual)
72101501 - Canes & walkers

// Peer Support
93150101 - Peer emotional support
93150305 - Computer & tech skills teaching
93150205 - Rides & transportation assistance

// Essentials
72100106 - First aid kits
60100101 - School supplies
49100101 - Diapers
```

### Integration with Mutual Aid Codec

The UNSPSC codes are embedded in the binary message format:
- **Field**: UNSPSC Code (4 bytes in binary message)
- **Format**: 8-digit integer (e.g., `50201506`)
- **Validation**: Must exist in reference and be appropriate for message type
- **Display**: Looked up from `UNSPSC_CODES` mapping for human-readable description

### Key Technologies

### Backend (Go)
- **Wesh Protocol**: Core P2P protocol (formerly "Berty Protocol")
- **IPFS**: InterPlanetary File System for peer discovery and content routing
- **OrbitDB**: Distributed database for group state management
- **gomobile**: Go mobile bindings for React Native integration
- **BLE**: Bluetooth Low Energy for local device discovery
- **mDNS**: Multicast DNS for local network discovery
- **Tor**: Optional anonymous routing

### Frontend (React Native)
- **React Native**: Cross-platform mobile framework
- **Redux**: State management
- **React Navigation**: Navigation library
- **TypeScript**: Type-safe JavaScript
- **gRPC Bridge**: Communication with Go backend via gomobile

### Protocol & Networking
- **End-to-end encryption**: Default message encryption
- **Peer-to-peer**: No central servers required
- **Offline-first**: Works without internet via BLE/mDNS
- **Group messaging**: OrbitDB-based group state synchronization

## Planned Modifications for Gratitude Fork

### New Backend Components (Go)
```
go/pkg/bertyprotocol/codec/
├── mutual_aid_message.go    # Binary codec (64-75 bytes)
├── codec_test.go            # Codec tests
└── validation.go            # Message validation
```

### New Frontend Components (React Native)
```
js/packages/
├── services/
│   ├── codec.ts             # TypeScript codec
│   ├── validation.ts        # Validation logic
│   └── matching.ts          # Semantic matching algorithm
├── redux/slices/
│   └── mutualAid.ts         # Redux state for offers/needs
├── screens/
│   ├── OfferListScreen.tsx  # Browse offers
│   ├── NeedListScreen.tsx   # Browse needs
│   ├── CreateOfferScreen.tsx
│   ├── CreateNeedScreen.tsx
│   ├── DetailScreen.tsx
│   └── MatchesScreen.tsx
└── components/
    ├── OfferCard.tsx
    ├── NeedCard.tsx
    └── CategoryIcon.tsx
```

### New Documentation
```
docs/
├── ARCHITECTURE.md          # System architecture
├── DEVELOPMENT.md           # Setup instructions
├── DESIGN.md                # Integration design
├── CODEC.md                 # Binary format reference
├── MATCHING.md              # Matching algorithm
├── ETHICS.md                # Mutual aid philosophy
├── ROADMAP.md               # Future plans
└── USER_GUIDE.md            # End-user documentation
```

## Message Format (Planned)

### Mutual Aid Binary Codec
- **Size**: 64-75 bytes (fits within BLE 512-byte limit)
- **Format**: Custom binary serialization
- **Fields**:
  - Version (1 byte)
  - Message Type (1 byte): OFFER (0), NEED (1), MATCH (2)
  - UNSPSC Code (4 bytes): Product/service category
  - Start/End Time (8 bytes each): Availability windows
  - Latitude/Longitude (8 bytes each): Location
  - Public Key (32 bytes): Ed25519 signature
  - Optional Fields: Quantity, UOM, floor, room, dietary restrictions

### UNSPSC Categories (Examples)
```
50201506  - Fresh produce
50201507  - Fresh fruits
50201710  - Prepared meals
48191503  - Clothing/apparel
72101505  - Medical supplies (OTC)
81100000  - Community/social services
```

## Current Development Status

### Completed
- ✅ Repository cloned locally
- ✅ Development environment setup
- ✅ BLE transport layer simplified (react-native-ble-plx)
- ✅ Android build working

### In Progress (Phase 1)
- [ ] Fork Berty repository to `colin-roy-ehri/gratitude`
- [ ] Study Berty architecture (Wesh Protocol, message pipeline)
- [ ] Verify baseline Berty functionality
- [ ] Create initial documentation (ARCHITECTURE.md, DEVELOPMENT.md)

### Upcoming (Phase 2)
- [ ] Implement binary codec in Go
- [ ] Extend protocol.proto with MutualAidMessage type
- [ ] Create TypeScript codec for React Native
- [ ] Integrate codec into message pipeline

## Important Files to Review

### Backend Entry Points
- `go/cmd/berty/main.go` - Main CLI entry point
- `go/pkg/bertybridge/` - Mobile bridge to React Native
- `go/pkg/bertymessenger/` - Messenger service implementation
- `api/messengertypes/messengertypes.proto` - Message type definitions

### Frontend Entry Points
- `js/index.ts` - React Native app entry point
- `js/packages/redux/` - State management
- `js/packages/screens/` - UI screens
- `js/packages/grpc-bridge/` - Go backend communication

### Documentation
- `README.md` - Main project README
- `docs/BERTY_DEVELOPMENT_PLAN.md` - ⭐ Complete development plan
- `docs/architecture/` - Architecture diagrams and decisions
- `docs/protocol/README.md` - Protocol documentation

## Build & Development

### Backend (Go)
```bash
# Build CLI
cd go
make

# Run daemon
go run ./cmd/berty daemon

# Run mini CLI messenger
go run ./cmd/berty mini
```

### Frontend (React Native)
```bash
cd js
yarn install

# Android
yarn android

# iOS
yarn ios
```

## Design Constraints & Decisions

### Intentional Design Choices
1. **No Reputation System**: Prevents "worthy vs unworthy" hierarchies
2. **No Monetary Exchange**: Prevents commodification
3. **Categories Only**: Reduces harassment, uses UNSPSC codes
4. **Local Matching First**: All matching happens on-device
5. **No Centralized Moderation**: Groups moderate themselves

### Technical Constraints
1. **BLE Range**: ~100 meters (mitigated with WiFi P2P/internet fallback)
2. **Message Size**: 512 bytes BLE limit (codec uses 64-75 bytes)
3. **P2P Groups**: Uses group messaging, not direct messaging
4. **Multi-Platform**: iOS, Android, Web support via React Native

## Testing Strategy

### Current Testing
- Unit tests for Go packages
- Integration tests for message pipeline
- E2E tests in `js/e2e-tests/`

### Planned Testing (Gratitude)
- Codec round-trip serialization tests
- Message validation tests
- Matching algorithm tests
- Alpha testing with Free Store community (10-20 users)

## Privacy & Security

### Current Berty Features
- End-to-end encryption by default
- No phone number or email required
- Minimal metadata
- Works on adversarial networks
- BLE for offline communication

### Gratitude Additions
- Location privacy (show distance bands, not exact coordinates)
- Anonymous by default
- No tracking or analytics
- Local-only semantic matching (no cloud AI)

## References

- **Berty Website**: https://berty.tech/
- **Berty GitHub**: https://github.com/berty/berty
- **Wesh Protocol Docs**: https://berty.tech/docs/protocol/
- **UNSPSC Codes**: https://www.unspsc.org/
- **Mutual Aid Info**: https://www.mutualaidproject.org/

## Development Workflow

1. **Current Phase**: Phase 1 - Foundation & Setup
2. **Next Steps**:
   - Fork repository to personal GitHub
   - Deep dive into Wesh Protocol architecture
   - Document message serialization/deserialization flow
   - Verify baseline Berty functionality on devices
3. **Branching Strategy**:
   - `main` → stable releases
   - `develop` → active development
   - `feature/*` → feature branches
   - `wip/*` → work-in-progress

## Notes for AI Assistant

- This is a fork-in-progress; respect upstream Berty architecture
- Focus on minimal, surgical modifications to Berty codebase
- Prioritize privacy and offline-first design
- Keep binary message format compact (64-75 bytes)
- Document all changes thoroughly
- Test on physical Android devices (BLE requires real hardware)
- Follow mutual aid principles: no hierarchy, no commodification
- Maintain compatibility with Berty's existing message pipeline
